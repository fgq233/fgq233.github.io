### 分布式事务理论基础
### 一、传统事务、分布式事务
#### 1. 传统事务ACID特性
* 原子性 (Atomicity)：事务为一个不可分割的最小工作单元，事务中的所有操作要么全部成功，要么全部失败
* 一致性(Consistency)：事务必须使数据库从一个一致性状态变换到另外一个一致性状态
* 隔离性(Isolation)：一个事务所做的修改在最终提交以前，对其他事务是不可见的
* 持久性(Durability)：一旦事务提交，则其所做的修改就会永久保存到数据库中，接下来即使数据库发生故障也不应该对其有任何影响

#### 2. 分布式事务
分布式事务是指不是在单个服务或单个数据库架构下产生的事务：
* 跨数据源的分布式事务
* 跨服务的分布式事务
* 综合情况



### 二、CAP定理
#### 1. 三个指标
分布式系统有三个指标，这三个指标不可能同时做到，这就是 CAP 定理
* Consistency（一致性）：用户访问分布式系统中的任意节点，得到的数据必须一致
* Availability（可用性）：用户访问集群中的任意健康节点，必须能得到响应，而不是超时或拒绝
* Partition tolerance（分区容错性）
  * 分区Partition：因为网络故障或其它原因导致分布式系统中的部分节点与其它节点失去连接，形成独立分区
  * 容错Tolerance：在集群出现分区时，整个系统也要持续对外提供服务

![CAP](https://fgq233.github.io/imgs/springcloud/seata1.png)

#### 2.矛盾
分布式系统中，网络不能100%保证健康，一定会有故障的时候，而服务必须对外保证服务，因此Partition Tolerance (P)不可避免

因为数据变更时，就会出现问题：

* 若此时要保证**一致性 C**，就必须等待网络恢复，完成节点之间数据同步后，整个集群才对外提供服务，服务处于阻塞状态不可用，违反可用性
* 若此时要保证**可用性 A**，就不能等待网络恢复，那么多个节点之间就会出现数据不一致情况，违反一致性

也就是在P一定会出现的情况下，A和C之间只能实现一个





### 三、BASE理论
#### 1. 三个思想
BASE理论是对CAP定理的一种解决思路，包含三个思想：
* Basically Available（基本可用）：分布式系统在出现故障时，允许损失部分可用性，保证核心可用
* Soft State（软状态）：在一定时间内，允许出现中间状态，比如临时的不一致状态
* Eventually Consistent（最终一致性）：虽然无法保证强一致性，但是在软状态结束后，最终达到数据一致

#### 2. 解决分布式事务的思路
分布式事务最大的问题是各个子事务的一致性问题，借鉴CAP定理和BASE理论，有两种解决思路：

* AP模式：各个子事务分别执行和提交，允许出现结果不一致，然后采用弥补措施恢复数据即可，实现**最终一致**

* CP模式：各个子事务执行后互相等待，同时提交，同时回滚，达成**强一致**，但事务等待过程中，处于弱可用状态

两种模式都需要在子事务之间互相通讯，协调事务状态，也就是**事务协调者(TC)**






