### MongoDB 集群部署模式

### 一、MongoDB 三种集群部署模式
MongoDB 有三种集群部署模式
* 主从复制（`Master-Slaver`）: 有固定的主节点、从节点，无法自动故障转移，mongodb4.0后不再支持

* 副本集（`Replica Set`）: 是一种互为主从的关系，类似于有**自动故障恢复**功能的主从集群，**不同服务器保存同一份数据**，
在出现故障时自动切换，实现故障转移
 
* 分片（`Sharding`）: 适合处理大量数据，它将数据分开存储，**不同服务器保存不同的数据**，
所有服务器数据的总和即为整个数据集



 
### 二、副本集
主从集群和副本集最大的区别就是副本集可以自动故障转移，没有固定的主节点，整个集群会选出一个主节点，
当其挂掉后，又在剩下的从节点中选中其他节点为主节点

#### 1. 三大角色
![mongodb](https://fgq233.github.io/imgs/java/mongodb1.png)

副本集有三种角色，其中仲裁者永远是仲裁者，而主要人员可能会退出并成为次要人员，
次要人员可能成为选举期间的主要成员

* 主要成员（`Primary`）：数据操作的主要连接点，可进行`读写操作`

* 副本成员（`Secondaries`）：从主要成员复制相同的数据集，即备份数据，不可写操作，但可以读操作（`需要配置`）

* 仲裁者（`Arbiter`）：不存储数据集，只有投票选举作用，占用资源成本低
    * 副本 + 主节点的个数是偶数，建议加一个仲裁者形成奇数，容易满足大多数的投票
    * 副本 + 主节点的个数是奇数，可以不加仲裁者
 
#### 2. 主节点选取时机  
MongoDB 在副本集中，会自动进行主节点的选举，主节点选举的触发条件：
* 主节点故障
* 主节点网络不可达（默认心跳信息为10秒）
* 人工干预（rs.stepDown(600)）

一旦触发选举，就要根据一定规则来选主节点 

#### 3. 主节点选取原则
选举规则是根据票数来决定谁获胜：
* 票数最高，且获得了 `大多数成员` 的投票支持的节点获胜
    * 大多数的定义为：假设副本集内投票成员数量为N，则大多数为 N/2 + 1，例如：3个投票成员，则大多数的值为2
    * 当副本集内存活成员数量不足大多数时，整个复制集将无法选举出Primary，副本集将无法提供写服务，处于只读状态

* 若票数相同，且都获得了 `大多数成员`的投票支持的，数据新的节点获胜
    * 数据的新旧是通过操作日志 `oplog` 来对比的


票数：
* 在获得票数的时候，优先级（priority）参数影响重大
* 可以通过设置优先级（priority）来设置额外票数，优先级即权重，取值为0-1000，相当于可额外增加0-1000的票数
* 优先级的值越大，就越可能获得多数成员的投票（votes）数，指定较高的值可使成员更有资格成为主要成员，更低的值可使成员更不符合条件
* 默认情况下，优先级的值是1

