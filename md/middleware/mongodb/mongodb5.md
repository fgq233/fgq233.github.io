### MongoDB 集群部署模式

### 一、MongoDB 三种集群部署模式
MongoDB 有三种集群部署模式
* 主从复制（`Master-Slaver`）: 有固定的主节点、从节点，无法自动故障转移，mongodb4.0后不再支持

* 副本集（`Replica Set`）: 是一种互为主从的关系，类似于有**自动故障恢复**功能的主从集群，**不同服务器保存同一份数据**，
在出现故障时自动切换，实现故障转移
 
* 分片（`Shard`）: 适合处理大量数据，它将数据分开存储，**不同服务器保存不同的数据**，
所有服务器数据的总和即为整个数据集



 
### 二、副本集 Replica Sets
* 副本集是一组维护相同数据集的mongod服务，就是用多台机器进行同一数据的异步同步，
从而使多台机器拥有同一数据的多个副本，并且当主库当掉时在不需要用户干预的情况下自动
切换其他备份服务器做主库。而且还可以利用副本服务器做只读服务器，实现读写分离，提高负载。
* 副本集类似于有自动故障恢复功能的主从集群，其没有固定的主节点，整个集群会选出一个主节点，
当其挂掉后，又在剩下的从节点中选中其他节点为主节点

#### 1. 三大角色
![mongodb](https://fgq233.github.io/imgs/java/mongodb1.png)

副本集有三种角色，其中仲裁者永远是仲裁者，而主要人员可能会退出并成为次要人员，
次要人员可能成为选举期间的主要成员

* 主要成员（`Primary`）：数据操作的主要连接点，可进行`读写操作`

* 副本成员（`Secondaries`）：从主要成员复制相同的数据集，即备份数据，不可写操作，但可以读操作（`需要配置`）

* 仲裁者（`Arbiter`）：不存储数据集，只有投票选举作用，占用资源成本低
    * 副本 + 主节点的个数是偶数，建议加一个仲裁者形成奇数，容易满足大多数的投票
    * 副本 + 主节点的个数是奇数，可以不加仲裁者
 
#### 2. 主节点选取时机  
MongoDB 在副本集中，会自动进行主节点的选举，主节点选举的触发条件：
* 主节点故障
* 主节点网络不可达（默认心跳信息为10秒）
* 人工干预（rs.stepDown(600)）

一旦触发选举，就要根据一定规则来选主节点 

#### 3. 主节点选取原则
选举规则是根据票数来决定谁获胜：
* 票数最高，且获得了 `大多数成员` 的投票支持的节点获胜
    * 大多数的定义为：假设副本集内投票成员数量为N，则大多数为 N/2 + 1，例如：3个投票成员，则大多数的值为2
    * 当副本集内存活成员数量不足大多数时，整个复制集将无法选举出Primary，副本集将无法提供写服务，处于只读状态

* 若票数相同，且都获得了 `大多数成员`的投票支持的，数据新的节点获胜
    * 数据的新旧是通过操作日志 `oplog` 来对比的


票数：
* 在获得票数的时候，优先级（priority）参数影响重大
* 可以通过设置优先级（priority）来设置额外票数，优先级即权重，取值为0-1000，相当于可额外增加0-1000的票数
* 优先级的值越大，就越可能获得多数成员的投票（votes）数，指定较高的值可使成员更有资格成为主要成员，更低的值可使成员更不符合条件
* 默认情况下，优先级的值是1，仲裁节点是0



### 三、分片集群 Shard Cluster
副本集中每台服务保存的数据是一致的，而分片集群是将数据拆分，将其分散存在不同的机器上，这样可以储存
更多的数据，处理更多的负载

#### 1. 三类服务
![mongodb](https://fgq233.github.io/imgs/java/mongodb3.png)

MongoDB分片群集包含三类服务
* 分片：每个分片包含分片数据的子集，每个分片可以是单机，也可以是副本集
* 路由：充当查询路由器，在客户端应用程序和分片集群之间提供接口
* 配置：存储分片集群的配置信息， 从MongoDB 3.4开始，必须将配置服务器部署为副本集


#### 2. 搭建步骤
* 搭建分片副本集，启动、初始化
* 搭建配置副本集，启动、初始化
* 搭建路由服务，启动
* 连接路由服务，添加分片、开启分片
